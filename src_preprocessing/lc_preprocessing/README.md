# Preprocessing data pipeline

### Goals

The code in `lc_preprocessing` is used for preprocessing the light curve data generated by the SPOC pipeline to create TFRecord datasets of transit signal
   observations (e.g., TCE and Objects of Interest datasets).

### Data Format

This project uses TFRecord format to save the processed data to be ingested by the models. This format stores a sequence
of binary records. Each TFRecord file has a set of examples (data points), each one with a given set of features. Check
[TFRecord tutorial](https://www.tensorflow.org/tutorials/load_data/tfrecord) for more information.

### Data preprocessing

The main scripts involved in preprocessing the data are `src_preprocessing.generate_input_records.py`
and `src_preprocessing.preprocessing.py`.\
The script `src_preprocessing.generate_input_records.py` is designed to preprocess batches of data in parallel using the
Python `multiprocessing.Pool` module, i.e., given a table of transit signals to be preprocessed, the
code splits the table into subsets, preprocessing each batch simultaneously. One can also use external parallel tools 
such as GNU Parallel along with script `preprocessing_job.sh`. 

#### Preprocessing steps

The main preprocessing steps are (check `src_preprocessing.preprocess.py`):

1. Get data from light curve FITS files for target stars of interest.
   1. Timestamps array: timestamps associated to the recorded cadences (a cadence is a single observation, data point).
   2. PDC-SAP flux time series (informally called 'flux'): consists of accumulated brightness for the pixels in the
      optimal aperture for the given target star.
   3. FW (flux-weighted) centroid motion time series: consists of weighted average centroid location in celestial 
   coordinates (RA and Dec) based on flux in the photometry aperture.
3. Remove stellar variability noise by fitting a trend to the timeseries, since this phenomenon occurs usually at a
   longer timescale than the transits.
4. Phase-fold the timeseries over the orbital period for the transit signal of interest.
5. Create a binned version (usually called 'view') of the phase-folded timeseries by averaging cadences in each bin.

#### Features

The features set in the TFRecords come from two sources:

1. The different views created in `src_preprocessing.preprocess.generate_example_for_tce()`.
2. Scalar features added to the TFRecords also in `src_preprocessing.preprocess.generate_example_for_tce()` that come
   from the transit signal table used as input (e.g. transit depth, weak secondary MES, other statistics and diagnostics
   computed in the DV module).

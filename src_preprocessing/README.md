# Preprocessing data pipeline

### Goals

The code in `src_preprocessing` is used to:

1. Preprocessing the light curve data generated by the SPOC pipeline to create TFRecord datasets of transit signal
   observations (e.g., TCE and Objects of Interest datasets).
2. Postprocessing the data preprocessed in step 1) (e.g., split data into training, validation and test sets,
   normalizing features using statistics computed from the training set, selecting subsets of data from the original
   dataset).

### Preprocessing the data

The main scripts involved in preprocessing the data are `src_preprocessing.generate_input_records.py`
and `src_preprocessing.preprocessing.py`.\
The script `src_preprocessing.generate_input_records.py` is designed to preprocess batches of data in parallel using the
MPI framework or Python `multiprocessin.Pool` module, i.e., given a table of transit signals to be preprocessed, the
code splits the table into subsets, preprocessing each batch simultaneously.

Snippet of code to run the preprocessing pipeline with MPI (e.g. on a cluster):

```shell
mpiexec -n $num_batches python src_preprocessing/generate_input_records.py  &>  log_py.txt
```

### Postprocessing the data

The following processes are modular and their application to the preprocessed data depends on the user's goals, but
usually the postprocessing pipeline resembles: 1) split the data into training, validation, test and/or prediction
(used for inference) sets; 2) computing normalization statistics based on the training set; use those statistics to
normalize input features in the datasets. Other steps such as updating labels based on different sets of dispositions or
selecting subsets of the data are also common tasks.

#### Splitting data into different datasets

This can be performed in `src_preprocessing.create_new_tfrecords.py`.

#### Updating labels

This can be performed in `src_preprocessing.update_labels_tfrecords.py`

#### Computing normalization statistics

This can be performed in `src_preprocessing.compute_normalization_stats_tfrecords.py`.

#### Normalizing datasets

This can be performed in `src_preprocessing.normalize_data_tfrecords.py`